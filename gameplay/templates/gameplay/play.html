{% extends "base.html" %}
{% block title %}Make a Guess{% endblock %}
{% block content %}

<div class="space-y-6">
  <h1 class="text-3xl text-gtgold font-bold text-center">Where is this?</h1>

  {% if error %}
    <div class="bg-red-100 text-red-800 border border-red-300 rounded-md px-4 py-2">
      {{ error }}
    </div>
  {% endif %}

  <!-- Photo with report toggle button -->
  <div class="flex justify-center">
    <div class="max-w-3xl w-full space-y-3">
      
      <img src="{{ challenge.image.url }}" alt="Challenge image"
          class="w-full object-contain max-h-[26rem] mx-auto rounded-lg shadow-lg" />

      <div class="flex justify-center">
        <button id="reportToggle"
                aria-expanded="false" aria-controls="reportPanel"
                class="bg-red-600 hover:bg-red-700 text-white rounded-md px-4 py-2 text-sm shadow">
          Report Photo
        </button>
      </div>

    </div>
  </div>

  <!-- Slide-down report panel -->
  <div id="reportPanel" class="max-w-xl mx-auto mb-4 hidden">
    {% if request.GET.reported == '1' %}
      <div class="bg-green-500 text-white p-3 rounded mb-3">Thank you — the photo has been reported.</div>
    {% elif request.GET.reported == '0' %}
      <div class="bg-yellow-500 text-white p-3 rounded mb-3">Please provide a reason when reporting.</div>
    {% endif %}

    {% if user.is_authenticated %}
      <form method="POST" action="{% url 'challenges.report' challenge.id %}"
            class="bg-gtblue p-4 rounded space-y-2 text-white">
        {% csrf_token %}

        <label class="block mb-1 font-semibold">Report this photo</label>

        <select name="reason" required class="w-full mb-2 p-2 rounded text-black" id="reasonSelect">
          <option value="">Select reason</option>
          <option value="inaccurate">Inaccurate location</option>
          <option value="inappropriate">Inappropriate content</option>
          <option value="spam">Spam / Duplicate</option>
          <option value="other">Other</option>
        </select>

        <textarea id="detailsField" name="details" rows="2"
                  placeholder="Optional details"
                  class="w-full p-2 rounded text-black hidden"
                  aria-hidden="true"></textarea>

        <button type="submit"
                class="w-full bg-red-600 hover:bg-red-700 px-3 py-2 rounded text-white font-semibold">
          Submit Report
        </button>
      </form>
    {% else %}
      <div class="text-sm text-gray-200">
        Please <a href="{% url 'accounts.login' %}" class="underline">log in</a> to report this photo.
      </div>
    {% endif %}
  </div>

  <!-- Guessing Section -->
  <div class="bg-white rounded-lg shadow p-4 text-gtblue space-y-4">
    <p class="text-sm text-gray-700">Drop a pin on the map to submit your guess.</p>

    <div id="map" class="w-full h-96 rounded-md border border-gtgold"></div>

    <form method="POST" class="space-y-3">
      {% csrf_token %}
      <input type="hidden" id="latitude" name="latitude" />
      <input type="hidden" id="longitude" name="longitude" />

      <div class="flex items-center gap-3 text-sm text-gray-700">
        <div class="flex items-center gap-1">
          <span class="font-semibold">Lat:</span>
          <span id="latDisplay">—</span>
        </div>
        <div class="flex items-center gap-1">
          <span class="font-semibold">Lon:</span>
          <span id="lonDisplay">—</span>
        </div>
      </div>

      <button type="submit"
              class="w-full bg-gtgold text-gtblue font-semibold px-4 py-2 rounded-md hover:bg-yellow-400">
        Submit Guess
      </button>
    </form>
  </div>
</div>

<!-- Leaflet CSS + JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Mapbox Token -->
<script>
  const MAPBOX_TOKEN = "{{ mapbox_token }}";
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const mapEl = document.getElementById("map");
  if (!mapEl) return;

  const latInput = document.getElementById("latitude");
  const lonInput = document.getElementById("longitude");
  const latDisplay = document.getElementById("latDisplay");
  const lonDisplay = document.getElementById("lonDisplay");

  // Initialize map
  const map = L.map("map").setView([33.7756, -84.3963], 15);
  let marker = null;

  L.tileLayer(
    `https://api.mapbox.com/styles/v1/mapbox/streets-v12/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`,
    {
      tileSize: 512,
      zoomOffset: -1,
      attribution: "Mapbox | OpenStreetMap",
      maxZoom: 19,
    }
  ).addTo(map);

  map.on("click", (e) => {
    const { lat, lng } = e.latlng;

    latInput.value = lat;
    lonInput.value = lng;
    latDisplay.textContent = lat.toFixed(5);
    lonDisplay.textContent = lng.toFixed(5);

    if (marker) map.removeLayer(marker);

    marker = L.marker([lat, lng], {
      icon: L.icon({
        iconUrl:
          "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png",
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
      }),
    })
      .addTo(map)
      .bindPopup(`Your Guess:<br>${lat.toFixed(5)}, ${lng.toFixed(5)}`)
      .openPopup();
  });

  const toggle = document.getElementById("reportToggle");
  const panel = document.getElementById("reportPanel");
  const reasonSelect = document.getElementById("reasonSelect");
  const detailsField = document.getElementById("detailsField");

  toggle?.addEventListener("click", (e) => {
    e.preventDefault();
    const nowHidden = panel.classList.toggle("hidden");
    toggle.setAttribute("aria-expanded", String(!nowHidden));

    if (!nowHidden) {
      panel.scrollIntoView({ behavior: "smooth", block: "center" });
    }
  });

  function updateDetailsVisibility() {
    if (!reasonSelect || !detailsField) return;
    if (reasonSelect.value) {
      detailsField.classList.remove("hidden");
      detailsField.setAttribute("aria-hidden", "false");
    } else {
      detailsField.classList.add("hidden");
      detailsField.setAttribute("aria-hidden", "true");
    }
  }

  reasonSelect?.addEventListener("change", updateDetailsVisibility);
  updateDetailsVisibility();
});
</script>

{% endblock %}
