{% extends "base.html" %}
{% block title %}Home{% endblock %}
{% block content %}

<div class="text-center mt-10">
  {% if user.is_authenticated %}
    <!-- Logged-in view -->
    <h1 class="text-4xl text-gtgold font-bold">
      Welcome back, {{ user.username }}!
    </h1>
    <p class="mt-4 text-lg text-white">
      Youâ€™re logged in. Ready to start guessing campus locations?
    </p>
    <div class="mt-8">
      <a href="{% url 'gameplay.start' %}" 
        class="bg-gtgold text-gtblue px-6 py-5 rounded-md font-semibold hover:bg-yellow-400">
        Start Playing
      </a>
    </div>
    <div class="mt-8">
      <button id="openUploadModal"
        class="bg-gtgold text-gtblue px-3 py-1 text-xs rounded-md font-semibold hover:bg-yellow-400">
        Upload Challenge
    </button>
    </div>
  {% else %}
    <!-- Not logged-in view -->
    <h1 class="text-4xl text-gtgold font-bold">
      Welcome to GTGuessr
    </h1>
    <p class="mt-4 text-lg text-white">
      Log in or sign up to start guessing!
    </p>
    <div class="mt-6">
      <a href="{% url 'accounts.login' %}" class="bg-gtgold text-gtblue px-4 py-2 rounded-md font-semibold hover:bg-yellow-400">
        Login
      </a>
      <a href="{% url 'accounts.signup' %}" class="ml-3 border border-gtgold px-4 py-2 rounded-md font-semibold text-gtgold hover:bg-gtgold hover:text-gtblue">
        Sign Up
      </a>
    </div>
  {% endif %}
</div>

<!-- Upload Modal -->
<div id="uploadModal"
  class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-lg p-6 relative">
    <button id="closeUploadModal"
      class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-2xl">&times;</button>

    <h2 class="text-2xl text-gtblue font-bold mb-4 text-center">Upload a New Challenge</h2>

    <ul class="mt-3 text-xs text-gray-600 list-disc list-inside bg-gray-50 p-3 rounded-md border">
      <strong>Submission Guidelines:</strong>
      <li>Must be a <strong>.jpg</strong>, <strong>.jpeg</strong>, <strong>.png</strong>, or <strong>.heic</strong> file</li>
      <li>Must be taken by you or someone who gave you permission</li>
      <li>Must show a location that is part of <strong>Georgia Tech campus</strong></li>
      <li>Should not prominently feature faces or identifiable individuals</li>
      <li>Maximum file size: <strong>10 MB</strong></li>
      <strong>*All submissions subject to admin review before appearing in game*</strong>
    </ul>

<form id="uploadForm" action="{% url 'challenges.upload' %}" method="POST" enctype="multipart/form-data">
  {% csrf_token %}

  <div class="mb-4">
    <label class="inline-block text-gray-700 font-medium mb-1 cursor-default" for="image">Image</label>
    <input type="file" id="image" name="image" accept=".jpg,.jpeg,.png,.heic"
      class="block w-full border border-gray-300 rounded-md p-2 text-gray-700 bg-white cursor-pointer text-sm"
      required>
  </div>

  <div class="flex space-x-4 mb-4">
    <div class="flex-1">
      <label for="latitude" class="block text-sm font-medium text-gray-700">Latitude</label>
      <input type="text" id="latitude" name="latitude"
            class="w-full border p-2 rounded bg-gray-100 text-gray-700" />
    </div>
    <div class="flex-1">
      <label for="longitude" class="block text-sm font-medium text-gray-700">Longitude</label>
      <input type="text" id="longitude" name="longitude"
            class="w-full border p-2 rounded bg-gray-100 text-gray-700" />
    </div>
  </div>

  <div id="map" class="h-64 w-full border rounded-md mb-4"></div>

  <button type="submit"
    class="bg-gtgold text-white px-4 py-2 rounded-md hover:bg-yellow-400 w-full">
    Upload
  </button>
</form>

  </div>
</div>

<!-- Leaflet + Modal Script -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Mapbox token -->
<script>
  const MAPBOX_TOKEN = "{{ mapbox_token }}";
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const modal = document.getElementById("uploadModal");
  const openBtn = document.getElementById("openUploadModal");
  const closeBtn = document.getElementById("closeUploadModal");

  // Open modal
  openBtn.addEventListener("click", () => {
    modal.classList.remove("hidden");
    modal.classList.add("flex");

    // Initialize map only once
    if (!window.uploadMapInitialized) {
      const map = L.map('map').setView([33.7766, -84.3963], 16);

      // Mapbox tiles
      L.tileLayer(
        `https://api.mapbox.com/styles/v1/mapbox/streets-v12/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`,
        {
          tileSize: 512,
          zoomOffset: -1,
          attribution: 'Mapbox | OpenStreetMap',
          maxZoom: 19
        }
      ).addTo(map);

      let marker;

      map.on('click', e => {
        if (marker) map.removeLayer(marker);
        marker = L.marker(e.latlng).addTo(map);
        document.getElementById('latitude').value = e.latlng.lat;
        document.getElementById('longitude').value = e.latlng.lng;
      });

      const latInput = document.getElementById("latitude");
      const lonInput = document.getElementById("longitude");

      function updateMarkerFromInputs() {
        const lat = parseFloat(latInput.value);
        const lon = parseFloat(lonInput.value);

        if (!isNaN(lat) && !isNaN(lon)) {
          const newLatLng = L.latLng(lat, lon);

          if (marker) {
            marker.setLatLng(newLatLng);
          } else {
            marker = L.marker(newLatLng).addTo(map);
          }

          map.setView(newLatLng, 16);
        }
      }

      latInput.addEventListener("change", updateMarkerFromInputs);
      lonInput.addEventListener("change", updateMarkerFromInputs);

      window.uploadMapInitialized = true;
    }
  });

  // Close modal
  closeBtn.addEventListener("click", () => {
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  });
});
</script>
{% endblock %}